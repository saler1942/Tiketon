{% extends 'base.html' %}

{% block title %}–°–ø–∏—Å–æ–∫ —Å–∫–∞–Ω–µ—Ä–æ–≤ | Freedom Ticketon | TEAM SYRYM{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-3" style="flex-wrap: wrap; gap: 1rem;">
    <h1>–°–ø–∏—Å–æ–∫ —Å–∫–∞–Ω–µ—Ä–æ–≤</h1>
    <div class="flex gap-2" style="flex-wrap: wrap;">
        <a href="{% url 'scanner_certificates' %}" class="btn btn-success">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</a>
    </div>
</div>

<form method="get" class="card mb-3 table-responsive" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: end;">
    <div style="flex:1; min-width: 180px; width: 100%;">
        <label for="q">–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏</label>
        <input type="text" id="q" name="q" class="form-control" value="{{ query|default:'' }}" placeholder="–ò–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—è">
    </div>
    <div style="min-width: 150px; width: calc(50% - 0.5rem);">
        <label for="min_hours">–ú–∏–Ω. —á–∞—Å–æ–≤</label>
        <input type="number" id="min_hours" name="min_hours" class="form-control" step="0.5" min="0" value="{{ min_hours|default:'' }}">
    </div>
    <div style="min-width: 150px; width: calc(50% - 0.5rem);">
        <label for="max_hours">–ú–∞–∫—Å. —á–∞—Å–æ–≤</label>
        <input type="number" id="max_hours" name="max_hours" class="form-control" step="0.5" min="0" value="{{ max_hours|default:'' }}">
    </div>
    <div style="min-width: 120px; width: 100%;">
        <button type="submit" class="btn btn-primary" style="width: 100%;">–ù–∞–π—Ç–∏</button>
    </div>
</form>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(0, 166, 81, 0.3); border-radius: 50%; border-top-color: #00a651; animation: spin 1s linear infinite;"></div>
    <p style="margin-top: 10px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
</div>

<div id="modal-error" style="display:none;position:fixed;z-index:99999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.18);padding:2.5rem 2rem;max-width:90vw;min-width:320px;text-align:center;position:relative;">
    <div style="font-size:3rem;line-height:1;margin-bottom:1rem;color:#00a651;">üéâ</div>
    <div id="modal-error-text" style="font-size:1.5rem;font-weight:600;margin-bottom:1.5rem;color:#222;">–û—à–∏–±–∫–∞</div>
    <button onclick="closeModalError()" style="background:#00a651;color:#fff;border:none;border-radius:8px;padding:0.7rem 2.5rem;font-size:1.1rem;font-weight:600;cursor:pointer;">OK</button>
  </div>
</div>

{% if scanners %}
<div class="card table-responsive">
    <table>
        <thead>
            <tr>
                <th>–ò–º—è</th>
                <th>–§–∞–º–∏–ª–∏—è</th>
                <th>–î–æ—Å—Ç—É–ø–Ω—ã–µ —á–∞—Å—ã</th>
                <th>–í—Å–µ–≥–æ —á–∞—Å–æ–≤</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for scanner in scanners %}
            <tr>
                <td>{{ scanner.first_name }}</td>
                <td>{{ scanner.last_name }}</td>
                <td>{{ scanner.total_hours }}</td>
                <td>{{ scanner.total_hours|add:scanner.total_certificate_hours }}</td>
                <td>
                    <a href="/certificates/scanner/{{ scanner.id }}/?format=pdf" class="btn btn-success" style="font-size: 0.8rem; padding: 0.2rem 0.5rem;">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</a>
                    <button onclick="toggleEvents({{ scanner.id }})" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.2rem 0.5rem;">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</button>
                </td>
            </tr>
            <tr id="events-{{ scanner.id }}" style="display: none;">
                <td colspan="5">
                    <div id="events-content-{{ scanner.id }}" style="padding: 1rem; background-color: #f8f9fa;">
                        <div class="events-loading" style="text-align: center; padding: 20px;">
                            <div class="spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0, 166, 81, 0.3); border-radius: 50%; border-top-color: #00a651; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 10px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</p>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="flex justify-center mt-3" style="flex-wrap: wrap;">
    <nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è" style="width: 100%; max-width: 400px;">
        <ul class="pagination" style="display: flex; gap: 0.5rem; list-style: none; padding: 0; justify-content: center; flex-wrap: wrap;">
            {% if page_obj.has_previous %}
                <li><a href="?{% if query %}q={{ query }}&{% endif %}{% if min_hours %}min_hours={{ min_hours }}&{% endif %}{% if max_hours %}max_hours={{ max_hours }}&{% endif %}page={{ page_obj.previous_page_number }}" class="btn btn-secondary">&laquo; –ù–∞–∑–∞–¥</a></li>
            {% endif %}
            <li style="padding: 0.5rem 1rem; text-align: center;">–°—Ç—Ä. {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</li>
            {% if page_obj.has_next %}
                <li><a href="?{% if query %}q={{ query }}&{% endif %}{% if min_hours %}min_hours={{ min_hours }}&{% endif %}{% if max_hours %}max_hours={{ max_hours }}&{% endif %}page={{ page_obj.next_page_number }}" class="btn btn-secondary">–í–ø–µ—Ä—ë–¥ &raquo;</a></li>
            {% endif %}
        </ul>
    </nav>
</div>
{% else %}
<div class="card" style="text-align: center; padding: 3rem 1rem;">
    <div style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;">üë§</div>
    <h2>–°–∫–∞–Ω–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h2>
    <p style="color: #666;">–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã—Ö —Å–∫–∞–Ω–µ—Ä–æ–≤ –≤ —Å–∏—Å—Ç–µ–º—É</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
    // –ö–µ—à –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö
    const eventsCache = {};
    
    function toggleEvents(scannerId) {
        const eventsRow = document.getElementById(`events-${scannerId}`);
        const eventsContent = document.getElementById(`events-content-${scannerId}`);
        
        if (eventsRow.style.display === 'none') {
            eventsRow.style.display = 'table-row';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –∫–µ—à–µ
            if (eventsCache[scannerId]) {
                eventsContent.innerHTML = eventsCache[scannerId];
            } else {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö —á–µ—Ä–µ–∑ API
                fetch(`/api/scanner-events/${scannerId}/`)
                    .then(response => response.json())
                    .then(data => {
                        let html = '<div style="margin-bottom: 1rem;">';
                        
                        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Å–∞—Ö
                        html += `
                            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                                <div style="flex: 1; min-width: 150px; background-color: #f8f9fa; padding: 1rem; border-radius: 8px;">
                                    <h4 style="margin-top: 0; font-size: 1rem;">–¢–µ–∫—É—â–∏–µ —á–∞—Å—ã</h4>
                                    <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0;">${data.current_hours}</p>
                                    <p style="color: #666; margin-top: 0.25rem; font-size: 0.8rem;">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</p>
                                </div>
                                <div style="flex: 1; min-width: 150px; background-color: #f8f9fa; padding: 1rem; border-radius: 8px;">
                                    <h4 style="margin-top: 0; font-size: 1rem;">–ü–æ–ª—É—á–µ–Ω–æ –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö</h4>
                                    <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0;">${data.total_certificate_hours}</p>
                                    <p style="color: #666; margin-top: 0.25rem; font-size: 0.8rem;">–†–∞–Ω–µ–µ –≤—ã–¥–∞–Ω–Ω—ã–µ —á–∞—Å—ã</p>
                                </div>
                                <div style="flex: 1; min-width: 150px; background-color: #e9f7ef; padding: 1rem; border-radius: 8px;">
                                    <h4 style="margin-top: 0; font-size: 1rem;">–í—Å–µ–≥–æ —á–∞—Å–æ–≤</h4>
                                    <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0;">${data.total_all_hours}</p>
                                    <p style="color: #666; margin-top: 0.25rem; font-size: 0.8rem;">–°—É–º–º–∞—Ä–Ω–æ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è</p>
                                </div>
                            </div>
                        `;
                        
                        html += '</div>';
                        
                        // –°–ø–∏—Å–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
                        html += '<h3 style="margin-bottom: 0.5rem;">–£—á–∞—Å—Ç–∏–µ –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö</h3>';
                        
                        if (data.events && data.events.length > 0) {
                            html += '<table style="width: 100%;">';
                            html += '<thead><tr><th>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</th><th>–î–∞—Ç–∞</th><th>–ß–∞—Å—ã</th></tr></thead><tbody>';
                            
                            data.events.forEach(event => {
                                html += `<tr><td>${event.name}</td><td>${event.date}</td><td>${event.hours}</td></tr>`;
                            });
                            
                            html += '</tbody></table>';
                        } else {
                            html += '<p>–ù–µ—Ç —É—á–∞—Å—Ç–∏—è –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö</p>';
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º
                        eventsCache[scannerId] = html;
                        eventsContent.innerHTML = html;
                    })
                    .catch(error => {
                        eventsContent.innerHTML = '<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</p>';
                        console.error('–û—à–∏–±–∫–∞:', error);
                    });
            }
        } else {
            eventsRow.style.display = 'none';
        }
    }

    function showModalError(message) {
        document.getElementById('modal-error-text').textContent = message;
        document.getElementById('modal-error').style.display = 'flex';
    }
    
    function closeModalError() {
        document.getElementById('modal-error').style.display = 'none';
    }

    function downloadCertificate(scannerId, el) {
        el.disabled = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('loading-indicator').style.display = 'block';
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const downloadUrl = `/certificates/scanner/${scannerId}/?format=pdf`;
        const downloadWindow = window.open(downloadUrl, '_blank');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            document.getElementById('loading-indicator').style.display = 'none';
            el.disabled = false;
        }, 2000);
        
        // –ï—Å–ª–∏ –æ–∫–Ω–æ –±—ã–ª–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (!downloadWindow || downloadWindow.closed || typeof downloadWindow.closed === 'undefined') {
            document.getElementById('loading-indicator').style.display = 'none';
            showModalError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞');
            el.disabled = false;
        }
    }
</script>
{% endblock %} 