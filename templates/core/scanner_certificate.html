{% extends 'base.html' %}

{% block title %}Генерация сертификатов | Freedom Ticketon | TEAM SYRYM{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-3" style="flex-wrap: wrap; gap: 1rem;">
    <h1>Сертификаты сканеров</h1>
    <div class="flex gap-2">
        <a href="{% url 'all_scanners_list' %}" class="btn btn-secondary">Список всех сканеров</a>
        <a href="{% url 'events' %}" class="btn btn-secondary">← Назад</a>
    </div>
</div>

<div class="card mb-3">
    <h2 class="mb-2">Поиск сканера</h2>
    <p class="mb-2" style="color: #666; word-break: break-word;">
        Найдите сканера по имени или email, чтобы создать для него сертификат со всеми мероприятиями, 
        в которых он участвовал, включая суммарные часы и период участия.
    </p>
    <div class="search-container mb-2" style="position:relative;">
        <div class="flex gap-2" style="flex-wrap: wrap;">
            <input id="scanner-search" type="text" class="form-control" placeholder="Поиск сканера по имени или email" autocomplete="off" style="flex:1; min-width: 100%;">
        </div>
    </div>
</div>

<div id="selected-scanner" class="card mb-3" style="display:none;">
    <h2 class="mb-2">Информация о сканере</h2>
    <div id="scanner-info" class="mb-3"></div>
    <div id="scanner-events" class="mb-3 table-responsive"></div>
    <div class="mt-3">
        <a id="generate-certificate-btn" href="#" class="btn btn-success" style="width: 100%; max-width: 300px;">Сгенерировать сертификат</a>
    </div>
</div>

<!-- Выпадающий список поиска вынесен в body -->
<div id="scanner-results" class="search-results" style="display:none; position:absolute; z-index:9999; min-width:220px;"></div>
{% endblock %}

{% block scripts %}
<style>
.search-results {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    max-height: 260px;
    overflow-y: auto;
    padding: 0.3rem 0;
}
.search-result-item {
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: background 0.15s;
}
.search-result-item:hover {
    background: #f3f3f3;
}
</style>
<script>
const searchInput = document.getElementById('scanner-search');
const resultsBox = document.getElementById('scanner-results');
const selectedScannerDiv = document.getElementById('selected-scanner');
const scannerInfoDiv = document.getElementById('scanner-info');
const scannerEventsDiv = document.getElementById('scanner-events');
const generateBtn = document.getElementById('generate-certificate-btn');
let timer;
let selectedScannerId = null;

function positionDropdown() {
    const rect = searchInput.getBoundingClientRect();
    resultsBox.style.position = 'absolute';
    resultsBox.style.left = rect.left + window.scrollX + 'px';
    resultsBox.style.top = rect.bottom + window.scrollY + 'px';
    resultsBox.style.width = rect.width + 'px';
}

searchInput.addEventListener('input', function() {
    clearTimeout(timer);
    const q = this.value.trim();
    if (q.length < 2) { 
        resultsBox.style.display = 'none'; 
        return; 
    }
    timer = setTimeout(() => {
        fetch(`/api/scanner-search/?q=${encodeURIComponent(q)}`)
            .then(r => r.json())
            .then(data => {
                resultsBox.innerHTML = '';
                if (data.results.length === 0) { 
                    resultsBox.style.display = 'none';
                    return; 
                }
                data.results.forEach(v => {
                    const div = document.createElement('div');
                    div.textContent = v.name + ' (' + v.email + ')';
                    div.className = 'search-result-item';
                    div.onclick = () => {
                        selectScanner(v.id, v.name, v.email);
                        resultsBox.style.display = 'none';
                    };
                    resultsBox.appendChild(div);
                });
                positionDropdown();
                resultsBox.style.display = 'block';
            })
            .catch(error => {
                resultsBox.style.display = 'none';
            });
    }, 200);
});

searchInput.addEventListener('focus', positionDropdown);
window.addEventListener('resize', positionDropdown);
window.addEventListener('scroll', positionDropdown, true);

document.addEventListener('click', function(e) {
    if (!resultsBox.contains(e.target) && e.target !== searchInput) {
        resultsBox.style.display = 'none';
    }
});

function selectScanner(id, name, email) {
    selectedScannerId = id;
    selectedScannerDiv.style.display = 'block';
    scannerInfoDiv.innerHTML = `
        <p><strong>ФИО:</strong> ${name}</p>
        <p><strong>Email:</strong> ${email}</p>
    `;
    scannerEventsDiv.innerHTML = '<p>Загрузка данных...</p>';
    generateBtn.style.display = 'none';
    fetch(`/api/scanner-events/${id}/`)
        .then(r => r.json())
        .then(data => {
            if (data.events.length === 0) {
                scannerEventsDiv.innerHTML = '<p>Сканер не участвовал ни в одном мероприятии</p>';
                generateBtn.style.display = 'none';
                return;
            }
            let eventsHtml = '<h3>Участие в мероприятиях:</h3>';
            eventsHtml += '<div class="table-responsive"><table style="width: 100%;"><thead><tr><th>Мероприятие</th><th>Дата</th><th>Часы</th></tr></thead><tbody>';
            data.events.forEach(event => {
                eventsHtml += `<tr><td>${event.name}</td><td>${event.date}</td><td>${event.hours}</td></tr>`;
            });
            eventsHtml += '</tbody></table></div>';
            
            // Добавляем информацию о часах
            eventsHtml += `
                <div style="margin-top: 1rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1; min-width: 200px; background-color: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-top: 0;">Текущие часы</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0;">${data.current_hours}</p>
                            <p style="color: #666; margin-top: 0.5rem;">Доступно для сертификата</p>
                        </div>
                        <div style="flex: 1; min-width: 200px; background-color: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-top: 0;">Получено в сертификатах</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0;">${data.total_certificate_hours}</p>
                            <p style="color: #666; margin-top: 0.5rem;">Ранее выданные часы</p>
                        </div>
                        <div style="flex: 1; min-width: 200px; background-color: #e9f7ef; padding: 1rem; border-radius: 8px;">
                            <h4 style="margin-top: 0;">Всего часов</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0;">${data.total_all_hours}</p>
                            <p style="color: #666; margin-top: 0.5rem;">Суммарно за все время</p>
                        </div>
                    </div>
                    <p style="margin-top: 1rem;"><strong>Период участия:</strong> ${data.first_date} - ${data.last_date}</p>
                </div>
            `;
            
            scannerEventsDiv.innerHTML = eventsHtml;
            
            // Показываем кнопку генерации сертификата только если есть доступные часы
            if (data.current_hours > 0) {
                generateBtn.style.display = 'inline-block';
                generateBtn.href = `/certificates/scanner/${id}/`;
            } else {
                generateBtn.style.display = 'none';
            }
        })
        .catch(error => {
            scannerEventsDiv.innerHTML = '<p class="text-danger">Ошибка при загрузке данных</p>';
        });
}
</script>
{% endblock %} 