# Настройка автоматического удаления мероприятий на Render

Эта инструкция поможет настроить Background Worker на Render для запуска задачи удаления старых мероприятий с 1 сентября 2024 года.

## Шаг 1: Создание Background Worker в Render

1. Войдите в ваш аккаунт на [Render](https://dashboard.render.com/)
2. Нажмите **New** и выберите **Background Worker**
3. Подключите ваш репозиторий GitHub с кодом проекта
4. Настройте следующие параметры:
   - **Name**: `tiketon-event-purger` (или любое другое название)
   - **Root Directory**: оставьте пустым, если ваш код находится в корне репозитория
   - **Runtime Environment**: `Docker`
   - **Instance Type**: `Starter` (минимальный тариф, т.к. воркер будет в основном спать)

## Шаг 2: Настройка переменных окружения

Добавьте следующие переменные окружения:

- `ADMIN_EMAIL`: Адрес электронной почты для получения уведомлений
- `EMAIL_HOST`: Хост SMTP-сервера (например, smtp.gmail.com)
- `EMAIL_PORT`: Порт SMTP-сервера (обычно 587 для TLS)
- `EMAIL_HOST_USER`: Имя пользователя SMTP (ваш email)
- `EMAIL_HOST_PASSWORD`: Пароль SMTP
- `EMAIL_USE_TLS`: `True`
- `DEFAULT_FROM_EMAIL`: Адрес отправителя
- `DATABASE_URL`: URL вашей базы данных (будет автоматически добавлен, если вы используете Render PostgreSQL)
- `SECRET_KEY`: Секретный ключ Django
- `RENDER_EXTERNAL_HOSTNAME`: Имя хоста вашего основного приложения на Render

## Шаг 3: Запуск сервиса

1. Нажмите **Create Background Worker**
2. Render автоматически создаст и запустит воркер используя Dockerfile в корне репозитория
3. Планировщик начнет работу и будет ждать до 1 сентября 2024 года, а затем начнет проверять и удалять старые мероприятия каждый день в 2:00

## Проверка настройки

После деплоя вы можете проверить, что планировщик запустился, просмотрев логи сервиса. Вы должны увидеть сообщения:
```
Scheduler started at: [текущая дата и время]
Automatic event purge will begin on September 1, 2024 at 2:00 AM
Next run scheduled at: [дата и время 1 сентября 2024, 2:00]
Sleeping for [количество] hours until next run
```

## Мониторинг и логи

Вы можете мониторить работу задачи через:
1. Раздел **Logs** в панели управления Render
2. Раздел **Events** для просмотра ошибок или перезапусков

## Настройка уведомлений Render

Чтобы получать уведомления о перезапусках или ошибках воркера:
1. Перейдите в раздел **Notifications** в настройках аккаунта Render
2. Добавьте интеграцию с Email или Slack
3. Настройте уведомления для вашего сервиса

## Тестирование функциональности

Если вы хотите протестировать функциональность удаления событий без ожидания:

1. Подключитесь к шеллу вашего сервиса через панель Render
2. Выполните команду:
   ```bash
   python manage.py purge_events --dry-run
   ```
3. Проверьте вывод, чтобы увидеть, какие события будут удалены

## Изменение даты запуска

Если вам нужно изменить дату начала:
1. Откройте файл `schedule_tasks.py`
2. Измените строку `start_date = datetime(2024, 9, 1, 2, 0, 0)`
3. Зайдите в панель управления Render
4. Перейдите на страницу вашего Background Worker
5. Нажмите **Manual Deploy** > **Deploy latest commit** 